String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),function(a){window.Chute||(window.Chute={}),Backbone.$=a;var b=Chute.View={skeleton:{initialize:function(a){_.forOwn(a,_.bind(function(a,b){_.contains(["model","parent","container"],b)?this[b]="object"==typeof this[b]&&"object"==typeof a?_.extend(this[b],a):a:this.options[b]=a},this)),a={},this._setContainer(),this.bindings&&(this._bindings=this.bindings,this.bindings={}),this.model&&this.listenTo(this.model,"change",this.render),this.template&&(this.template=_.bind(this.template,this)),this._initialize&&this._initialize()},_setContainer:function(){this.$container=this.parent?this.container?this.parent.$(this.container):this.parent.$el:a(this.container)},rendered:!1,render:function(b){if(b||(b={}),this.rendered)if(this.template){if(this.model){var c=this.model.changedAttributes();if(!c)return;if(this.bindings)_(c).forOwn(_.bind(function(a,b){this.bindings[b]&&this.bindings[b].html(a)},this));else{var d=this.template(_.extend({},this.model.attributes,this.options)).trim();this.undelegateEvents(),this.$el.replaceWith(d),this.delegateEvents(),this.updateBindings()}}else this.undelegateEvents(),this.$el.replaceWith(this.template(_.extend({},this.options))),this.delegateEvents(),this.updateBindings();b.silent||this.trigger("render")}else this.updateBindings();else{if(this.template){var e=this.append?"append":"prepend",f=this.model?this.model.attributes:null,d=this.template(_.extend({},f,this.options)).trim(),g=a(d);b.before?a(b.before).before(g):b.after?a(b.after).after(g):this.$container[e](g),this.setElement(g)}else this.setElement(this.$container);this.$el.data("view",this),this.model&&this.$el.data("model",this.model),this.updateBindings(),b.silent||this.trigger("render"),this.rendered=!0}},updateBindings:function(){if(this._bindings){var b=_.bind(function(c,d,e){_.forOwn(c,_.bind(function(c,f){"object"==typeof c?(d[f]={},b(c,d[f],"global"===f)):d[f]=(e?a(c):this.$(c))||a("")},this))},this);b(this._bindings,this.bindings)}},remove:function(){a.removeData(this.$el,"model"),a.removeData(this.$el,"view"),this.rendered=!1,this._remove&&this._remove(),this.trigger("remove",this),Backbone.View.prototype.remove.apply(this,arguments)},destroy:function(){this.remove(),this.parent&&delete this.parent,this.bindings&&(delete this.bindings,delete this._bindings),this.model&&delete this.model}},extend:function(a){return a.initialize&&(a._initialize=a.initialize,delete a.initialize),a.remove&&(a._remove=a.remove,delete a.remove),Backbone.View.extend(_.extend({},this.skeleton,a))}},c=Chute.Display={skeleton:{initialize:function(a){if(_.forOwn(a,_.bind(function(a,b){_.contains(["collection","model","parent","container"],b)?this[b]="object"==typeof this[b]&&"object"==typeof a?_.extend(this[b],a):a:this.options[b]=a},this)),a={},this._setContainer(),this.bindings&&(this._bindings=this.bindings,this.bindings={}),!this.collection){var b=Backbone.Collection.extend(this.model?{model:this.model}:null);this.collection=new b}if(this.itemView){var d=h.extend();this.views=new d,this.listenTo(this.views,"add",function(a,b,c){this._addView(a,c)}),this.listenTo(this.views,"reset",function(a,b){this._removeAll(b.previousModels)}),this._configureCollection()}this.template&&(this.template=_.bind(this.template,this)),this._initialize&&this._initialize(),(this.plugin||this.plugins)&&_.each(this.plugins||[this.plugin],_.bind(function(b){c.plugins[b]&&new c.plugins[b](this,a)},this))},setCollection:function(a){this.collection&&(this.views.reset(),delete this.collection.display,this.collection.stopListening(),this.stopListening(this.collection),delete this.collection),this.collection=a,this._configureCollection()},_configureCollection:function(){this.collection.display=this,this.listenTo(this.collection,"add",function(a,b,c){var d=new this.itemView({model:a,parent:this});this.views.add(d,c)}),this.listenTo(this.collection,"remove",this._removeByModel),this.listenTo(this.collection,"reset",this.views.reset)},render:function(){if(!this.rendered){if(this.template){var b=this.append?"append":"prepend",c=this.template(_.extend({},this.options)).trim(),d=a(c);this.$container[b](d),this.setElement(d)}else this.setElement(this.$container);this.$el.data("display",this),this.$el.data("collection",this.collection),this.updateBindings(),this.collection.each(_.bind(function(a){if(this.itemView){var b=new this.itemView({model:a,parent:this});this._addView(b)}},this)),this.trigger("render"),this.rendered=!0}},views:null,_addView:function(a,b){b||(b={}),b.add=!0,b.remove=!1,b.merge=!1,a.render(b.at&&b.at<this.views.length-1?{before:this.views.at(b.at+1).$el}:null),this.listenTo(a,"remove",_.bind(this._removeView,this,a)),this.updateBindings()},_removeView:function(a){this.views.remove(a,{silent:!1}),this.updateBindings()},_removeByModel:function(a){var b=this.views.find(function(b){return b.model.cid===a.cid});this.views.remove(b)},_removeAll:function(a){_.each(a,function(a){a.remove()}),this.updateBindings()},remove:function(){a.removeData(this.$el,"display"),a.removeData(this.$el,"collection"),this.views.reset(),this.rendered=!1,this._remove&&this._remove(),this.trigger("remove",this),Backbone.View.prototype.remove.apply(this,arguments)},destroy:function(){this.remove(),this.parent&&delete this.parent,this.bindings&&(delete this.bindings,delete this._bindings),this.model&&delete this.model,delete this.collection.display,delete this.collection.append,delete this.collection,delete this.views}},extend:function(a){return a.initialize&&(a._initialize=a.initialize,delete a.initialize),a.remove&&(a._remove=a._remove,delete a.remove),Backbone.View.extend(_.extend({},b.skeleton,this.skeleton,a))},requires:function(a,b){Chute.require(a,b)}};c.plugins={},c.Plugin=function(a,b){this.cid=_.uniqueId("plugin"),this.display=a,this.initialize(b)},c.Plugin.extend=function(a,b){var d,e=this;d=a&&_.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},_.extend(d,e,b);var f=function(){this.constructor=d};return f.prototype=e.prototype,d.prototype=new f,a&&_.extend(d.prototype,a),d.__super__=e.prototype,c.plugins[a.id]=d,d};var d=[],e=d.push,f=d.slice,g=d.splice,h=function(a,b){b||(b={}),b.url&&(this.url=b.url),b.model&&(this.model=b.model),void 0!==b.comparator&&(this.comparator=b.comparator),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a,_.extend({silent:!0},b))},i={add:!0,remove:!0,merge:!0};_.extend(h.prototype,Backbone.Events,Backbone.Collection.prototype,{set:function(a,b){b=_.defaults(b||{},i),_.isArray(a)||(a=a?[a]:[]);var c,d,f,h,j=b.at,k=this.comparator&&null==j&&b.sort!==!1;_.isString(this.comparator)?this.comparator:null;var l=[],m=[],n={};for(c=0,d=a.length;d>c;c++)(f=this._prepareModel(a[c],b))&&b.add&&(l.push(f),f.on("all",this._onModelEvent,this),this._byId[f.cid]=f,null!=f.id&&(this._byId[f.id]=f));if(b.remove){for(c=0,d=this.length;d>c;++c)n[(f=this.models[c]).cid]||m.push(f);m.length&&this.remove(m,b)}if(l.length&&(k&&(h=!0),this.length+=l.length,null!=j?g.apply(this.models,[j,0].concat(l)):e.apply(this.models,l)),h&&this.sort({silent:!0}),b.silent)return this;for(c=0,d=l.length;d>c;c++)(f=l[c]).trigger("add",f,this,_.extend(b,{at:c}));return h&&this.trigger("sort",this,b),this},_prepareModel:function(a){return a},_removeReference:function(a){a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"!==a&&"remove"!==a||c===this)&&("destroy"===a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))}});var j=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];_.each(j,function(a){h.prototype[a]=function(){var b=f.call(arguments);return b.unshift(this.models),_[a].apply(_,b)}});var k=["groupBy","countBy","sortBy"];_.each(k,function(a){h.prototype[a]=function(b,c){var d=_.isFunction(b)?b:function(a){return a.get(b)};return _[a](this.models,d,c)}}),h.extend=function(a,b){var c,d=this;c=a&&_.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},_.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&_.extend(c.prototype,a),c.__super__=d.prototype,c}}(window.jQueryChute||jQuery);